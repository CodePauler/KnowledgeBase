# æ•°æ®åº“æž¶æž„è®¾è®¡æ–‡æ¡£

## ä¸€ã€æ•´ä½“ ER å…³ç³»æ¢³ç†ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰

æ¨¡åž‹å¯ä»¥æŠ½è±¡æˆä¸€å¥è¯ï¼š

> **ç”¨æˆ· â†’ ç©ºé—´ â†’ çŸ¥è¯† â†’ å‘é‡ï¼ˆRAGï¼‰**

### æ•°æ®åº“æ‹†åˆ†ç­–ç•¥

| æ•°æ®åº“ | è¡¨ | ç”¨é€” |
|--------|-----|------|
| **MySQL 8.0** | `users` | ä¸šåŠ¡æ•°æ®ï¼šç”¨æˆ·ä¿¡æ¯ |
| **MySQL 8.0** | `spaces` | ä¸šåŠ¡æ•°æ®ï¼šçŸ¥è¯†åº“ç©ºé—´ |
| **MySQL 8.0** | `knowledge` | ä¸šåŠ¡æ•°æ®ï¼šçŸ¥è¯†æ¡ç›® |
| **PostgreSQL + pgvector** | `document_chunk` | å‘é‡æ•°æ®ï¼šRAG æ£€ç´¢ |

**è®¾è®¡åŽŸåˆ™**ï¼šä¸šåŠ¡æ•°æ®ä¸Žå‘é‡æ•°æ®åˆ†ç¦»ï¼ŒMySQL è´Ÿè´£ç»“æž„åŒ–æ•°æ®ï¼ŒPostgreSQL + pgvector è´Ÿè´£å‘é‡æ£€ç´¢ã€‚

---

### ER å›¾ï¼ˆMermaidï¼‰

```mermaid
erDiagram
    USERS ||--o{ SPACES : "æ‹¥æœ‰"
    SPACES ||--o{ KNOWLEDGE : "åŒ…å«"
    KNOWLEDGE ||--o{ KNOWLEDGE : "çˆ¶å­å…³ç³»"
    KNOWLEDGE ||--o{ DOCUMENT_CHUNK : "å‘é‡åŒ–"
    
    USERS {
        bigint id PK
        varchar username UK
        varchar password
        varchar email
        timestamp created_at
        timestamp updated_at
    }
    
    SPACES {
        bigint id PK
        bigint user_id FK
        varchar name
        text description
        timestamp created_at
        timestamp updated_at
    }
    
    KNOWLEDGE {
        bigint id PK
        bigint space_id FK
        varchar title
        enum type "DOC/MANUAL"
        longtext content "æ‰‹å·¥å½•å…¥å†…å®¹"
        bigint parent_id FK "æ ‘å½¢ç»“æž„"
        varchar blob_key "æ–‡ä»¶å­˜å‚¨è·¯å¾„"
        varchar parse_job "PENDING/RUNNING/DONE/FAILED"
        timestamp created_at
        timestamp updated_at
    }
    
    DOCUMENT_CHUNK {
        serial id PK "PostgreSQL"
        vector embedding "å‘é‡ 1536ç»´"
        jsonb metadata "knowledgeId/spaceId"
        text content "æ–‡æœ¬ç‰‡æ®µ"
    }
```

---

## äºŒã€MySQL æ•°æ®åº“è¡¨è¯¦è§£

### 1ï¸âƒ£ ç”¨æˆ·è¡¨ï¼ˆusersï¼‰

* **ä¸€ä¸ªç”¨æˆ·å¯ä»¥æ‹¥æœ‰å¤šä¸ªçŸ¥è¯†åº“ç©ºé—´**
* `users.id` â† `spaces.user_id`

```text
users 1 â”€â”€â”€â”€ N spaces
```

ç”¨æˆ·æ˜¯**æƒé™å’Œæ‰€æœ‰æƒçš„æœ€å¤–å±‚è¾¹ç•Œ**

#### è¡¨ç»“æž„

| å­—æ®µ | ç±»åž‹ | çº¦æŸ | è¯´æ˜Ž |
|------|------|------|------|
| `id` | BIGINT | PRIMARY KEY | ä¸»é”® |
| `username` | VARCHAR(255) | UNIQUE NOT NULL | ç”¨æˆ·åï¼ˆå”¯ä¸€ï¼‰ |
| `password` | VARCHAR(255) | NOT NULL | BCrypt åŠ å¯†å¯†ç  |
| `email` | VARCHAR(255) | | é‚®ç®± |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

#### DDL

```sql
CREATE TABLE users (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    username VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

---

### 2ï¸âƒ£ çŸ¥è¯†åº“ç©ºé—´è¡¨ï¼ˆspacesï¼‰

ç©ºé—´æ˜¯ä¸€ä¸ª**é€»è¾‘çŸ¥è¯†åº“å®¹å™¨**ï¼Œç”¨äºŽï¼š

* æŒ‰é¡¹ç›® / è¯¾ç¨‹ / ç ”ç©¶æ–¹å‘ / å…¬å¸éƒ¨é—¨åˆ’åˆ†
* ä½œä¸º **RAG æ£€ç´¢ä¸Žæƒé™éš”ç¦»çš„æœ€å°å•å…ƒ**

```text
spaces 1 â”€â”€â”€â”€ N knowledge
```

* `spaces.id` â† `knowledge.space_id`

#### è¡¨ç»“æž„

| å­—æ®µ | ç±»åž‹ | çº¦æŸ | è¯´æ˜Ž |
|------|------|------|------|
| `id` | BIGINT | PRIMARY KEY | ä¸»é”® |
| `user_id` | BIGINT | FOREIGN KEY | å¤–é”® â†’ users.id |
| `name` | VARCHAR(255) | NOT NULL | ç©ºé—´åç§° |
| `description` | TEXT | | ç©ºé—´æè¿° |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

#### DDL

```sql
CREATE TABLE spaces (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

---

### 3ï¸âƒ£ çŸ¥è¯†æ¡ç›®è¡¨ï¼ˆknowledgeï¼‰â€”â€”æ ¸å¿ƒè¡¨

è¿™æ˜¯**æ•´ä¸ªç³»ç»Ÿæœ€å…³é”®çš„è¡¨**ï¼Œå®ƒç»Ÿä¸€æ‰¿è½½äº†ï¼š

| ç±»åž‹ | æžšä¸¾å€¼ | è¯´æ˜Ž |
|------|--------|------|
| æ–‡æ¡£ç±» | `DOC` | ä¸Šä¼ çš„ PDF/DOCX ç­‰æ–‡ä»¶ |
| æ‰‹å·¥å½•å…¥ | `MANUAL` | Markdown ç¬”è®° |

#### è¡¨ç»“æž„

| å­—æ®µ | ç±»åž‹ | çº¦æŸ | è¯´æ˜Ž |
|------|------|------|------|
| `id` | BIGINT | PRIMARY KEY | ä¸»é”® |
| `space_id` | BIGINT | FOREIGN KEY | å¤–é”® â†’ spaces.id |
| `title` | VARCHAR(255) | NOT NULL | çŸ¥è¯†æ ‡é¢˜ |
| `type` | ENUM('DOC', 'MANUAL') | NOT NULL | çŸ¥è¯†ç±»åž‹ |
| `content` | LONGTEXT | | æ‰‹å·¥å½•å…¥çš„ Markdown å†…å®¹ |
| `parent_id` | BIGINT | FOREIGN KEY | å¤–é”® â†’ knowledge.idï¼ˆæ ‘å½¢ç»“æž„ï¼‰ |
| `blob_key` | VARCHAR(255) | | æ–‡ä»¶å­˜å‚¨è·¯å¾„ï¼ˆAzure Blobï¼‰ |
| `parse_job` | VARCHAR(50) | | æ–‡æ¡£è§£æžçŠ¶æ€ï¼šPENDING/RUNNING/DONE/FAILED |
| `created_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE | æ›´æ–°æ—¶é—´ |

#### å±‚çº§ç»“æž„ï¼ˆçŸ¥è¯†æ ‘ï¼‰

```sql
parent_id BIGINT
FOREIGN KEY (parent_id) REFERENCES knowledge(id)
```

æ”¯æŒï¼š

* ç›®å½• / å­ç›®å½•
* æ‰‹å·¥ç»“æž„åŒ–çŸ¥è¯†çš„**çˆ¶å­èŠ‚ç‚¹**

```text
knowledge (çˆ¶)
   â””â”€â”€ knowledge (å­)
```

#### DDL

```sql
CREATE TABLE knowledge (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    space_id BIGINT NOT NULL,
    title VARCHAR(255) NOT NULL,
    type ENUM('DOC', 'MANUAL') NOT NULL,
    content LONGTEXT,
    parent_id BIGINT,
    blob_key VARCHAR(255),
    parse_job VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (space_id) REFERENCES spaces(id) ON DELETE CASCADE,
    FOREIGN KEY (parent_id) REFERENCES knowledge(id) ON DELETE CASCADE
);
```

---

## ä¸‰ã€PostgreSQL å‘é‡æ•°æ®åº“è¡¨è¯¦è§£

### å‘é‡å­˜å‚¨è¡¨ï¼ˆdocument_chunkï¼‰

**ä½äºŽ PostgreSQL æ•°æ®åº“**ï¼Œä½¿ç”¨ **pgvector æ‰©å±•**ï¼Œç”¨äºŽ RAG è¯­ä¹‰æ£€ç´¢ã€‚

#### è¡¨ç»“æž„

| å­—æ®µ | ç±»åž‹ | è¯´æ˜Ž |
|------|------|------|
| `id` | SERIAL | ä¸»é”®ï¼ˆè‡ªå¢žï¼‰ |
| `embedding` | VECTOR(1536) | å‘é‡ï¼ˆ1536 ç»´ï¼Œæ™ºè°± Embedding-3ï¼‰ |
| `metadata` | JSONB | å…ƒæ•°æ®ï¼š`{knowledgeId, spaceId, blobKey, filename}` |
| `content` | TEXT | æ–‡æœ¬ç‰‡æ®µ |

#### ç´¢å¼•ï¼ˆIVFFLATï¼‰

```sql
CREATE INDEX ON document_chunk USING ivfflat (embedding vector_cosine_ops);
```

**ç´¢å¼•è¯´æ˜Ž**ï¼š
* **IVFFLAT**ï¼šåå‘æ–‡ä»¶ç´¢å¼• + æ‰å¹³é‡åŒ–ï¼Œé€‚åˆä¸­ç­‰è§„æ¨¡å‘é‡æ£€ç´¢
* **vector_cosine_ops**ï¼šä½™å¼¦ç›¸ä¼¼åº¦è¿ç®—ç¬¦

#### å…ƒæ•°æ®ç¤ºä¾‹

```json
{
  "knowledgeId": 123,
  "spaceId": 456,
  "blobKey": "knowledge/uuid-12345",
  "filename": "java-design-patterns.pdf"
}
```

#### DDLï¼ˆSpring AI è‡ªåŠ¨åˆ›å»ºï¼‰

```sql
CREATE EXTENSION IF NOT EXISTS vector;

CREATE TABLE IF NOT EXISTS document_chunk (
    id SERIAL PRIMARY KEY,
    embedding vector(1536),
    metadata jsonb,
    content text
);

CREATE INDEX IF NOT EXISTS document_chunk_embedding_idx 
ON document_chunk USING ivfflat (embedding vector_cosine_ops);
```

---

## å››ã€è¡¨é—´å…³ç³»æ€»ç»“

| è¡¨ | æ•°æ®åº“ | è§’è‰² |
|----|--------|------|
| `users` | MySQL | æ‰€æœ‰æƒã€æƒé™ä¸»ä½“ |
| `spaces` | MySQL | çŸ¥è¯†éš”ç¦» + RAG æ£€ç´¢è¾¹ç•Œ |
| `knowledge` | MySQL | ç»Ÿä¸€çŸ¥è¯†æŠ½è±¡ï¼ˆæ–‡æ¡£ / æ‰‹å·¥ï¼‰ |
| `document_chunk` | PostgreSQL | RAG å‘é‡å­˜å‚¨ |

### å…³ç³»é“¾è·¯

```text
users (1) â”€â”€â†’ (N) spaces (1) â”€â”€â†’ (N) knowledge
                                      â†“
                                  (N) document_chunk (å‘é‡åŒ–)
```

---

## äº”ã€ä¸¤ç±»çŸ¥è¯†çš„æ•°æ®æµ

### ðŸ”¹ 1. æ–‡æ¡£ç±»çŸ¥è¯†ï¼ˆDOCï¼‰

**å…¸åž‹ï¼šPDF / Word / Markdown / PPT**

| å­—æ®µ | ç”¨æ³• |
|------|------|
| `type` | `DOC` |
| `title` | æ–‡ä»¶å / æ–‡æ¡£æ ‡é¢˜ |
| `blob_key` | Azure Blob Storage è·¯å¾„ |
| `content` | âŒ é€šå¸¸ä¸ºç©º |
| `parent_id` | å¯é€‰ï¼ˆæ”¾åœ¨æŸç›®å½•ä¸‹ï¼‰ |
| `parse_job` | PENDING â†’ RUNNING â†’ DONE/FAILED |

#### æ•°æ®æµ

```text
ç”¨æˆ·ä¸Šä¼ æ–‡ä»¶
  â†“
Azure Blob Storage (å­˜å‚¨åŽŸæ–‡ä»¶)
  â†“
blob_key ä¿å­˜åˆ° knowledge è¡¨
  â†“
DocumentParseService (å¼‚æ­¥è§£æž)
  â”œâ”€ Tika æå–æ–‡æœ¬
  â”œâ”€ TokenTextSplitter åˆ†ç‰‡
  â”œâ”€ EmbeddingModel å‘é‡åŒ–
  â””â”€ å­˜å‚¨åˆ° PostgreSQL document_chunk
```

---

### ðŸ”¹ 2. æ‰‹å·¥å½•å…¥ç±»çŸ¥è¯†ï¼ˆMANUALï¼‰

**å…¸åž‹ï¼šMarkdown ç¬”è®°**

| å­—æ®µ | ç”¨æ³• |
|------|------|
| `type` | `MANUAL` |
| `title` | æ ‡é¢˜ |
| `content` | æ‰‹å·¥è¾“å…¥çš„ Markdown æ­£æ–‡ |
| `parent_id` | å¯é€‰ï¼ˆåˆ†ç±»ï¼‰ |
| `blob_key` | âŒ ä¸ºç©º |

#### æ•°æ®æµ

```text
ç”¨æˆ·åœ¨ç¼–è¾‘å™¨è¾“å…¥ Markdown
  â†“
content ä¿å­˜åˆ° knowledge è¡¨
  â†“
DocumentParseService.embedMarkdown()
  â”œâ”€ TokenTextSplitter åˆ†ç‰‡
  â”œâ”€ EmbeddingModel å‘é‡åŒ–
  â””â”€ å­˜å‚¨åˆ° PostgreSQL document_chunk
```

---

## å…­ã€ç”¨æˆ·ã€Œä¸Šä¼  / å½•å…¥çŸ¥è¯†ã€æ—¶éœ€è¦é‡‡é›†å“ªäº›å­—æ®µï¼Ÿ

### åœºæ™¯ 1ï¼šä¸Šä¼ æ–‡æ¡£ç±»çŸ¥è¯†

#### å‰ç«¯éœ€è¦é‡‡é›†

| å­—æ®µ | å¿…å¡« | è¯´æ˜Ž |
|------|------|------|
| `space_id` | âœ… | æ”¾å…¥å“ªä¸ªçŸ¥è¯†åº“ |
| `title` | âœ… | æ–‡ä»¶åï¼ˆå¯ç¼–è¾‘ï¼‰ |
| `type` | å›ºå®š | `DOC` |
| `file` | âœ… | åŽŸå§‹æ–‡ä»¶ |
| `parent_id` | âŒ | æ‰€å±žç›®å½• |

#### åŽç«¯éœ€è¦å­˜å‚¨

**MySQL knowledge è¡¨**

```json
{
  "space_id": 456,
  "title": "Javaè®¾è®¡æ¨¡å¼.pdf",
  "type": "DOC",
  "blob_key": "knowledge/uuid-12345",
  "parent_id": null,
  "parse_job": "PENDING"
}
```

**PostgreSQL document_chunk è¡¨ï¼ˆå¼‚æ­¥å†™å…¥ï¼‰**

```json
{
  "embedding": [0.123, -0.456, ...],
  "metadata": {
    "knowledgeId": 123,
    "spaceId": 456,
    "blobKey": "knowledge/uuid-12345",
    "filename": "Javaè®¾è®¡æ¨¡å¼.pdf"
  },
  "content": "å•ä¾‹æ¨¡å¼æ˜¯ä¸€ç§åˆ›å»ºåž‹è®¾è®¡æ¨¡å¼..."
}
```

---

### åœºæ™¯ 2ï¼šäººå·¥å½•å…¥ Markdown çŸ¥è¯†

#### å‰ç«¯éœ€è¦é‡‡é›†

| å­—æ®µ | å¿…å¡« | è¯´æ˜Ž |
|------|------|------|
| `space_id` | âœ… | çŸ¥è¯†åº“ |
| `title` | âœ… | æ ‡é¢˜ |
| `content` | âœ… | Markdown æ­£æ–‡ |
| `parent_id` | âŒ | åˆ†ç±» |
| `type` | å›ºå®š | `MANUAL` |

#### åŽç«¯éœ€è¦å­˜å‚¨

**MySQL knowledge è¡¨**

```json
{
  "space_id": 456,
  "title": "Vue3 å“åº”å¼åŽŸç†",
  "type": "MANUAL",
  "content": "# Vue3 å“åº”å¼åŽŸç†\n\nä½¿ç”¨ Proxy...",
  "parent_id": null
}
```

**PostgreSQL document_chunk è¡¨ï¼ˆåŒæ­¥å†™å…¥ï¼‰**

```json
{
  "embedding": [0.789, -0.234, ...],
  "metadata": {
    "knowledgeId": 124,
    "spaceId": 456
  },
  "content": "Vue3 å“åº”å¼åŽŸç†\n\nä½¿ç”¨ Proxy..."
}
```

---

## ä¸ƒã€è®¾è®¡ä¼˜åŠ¿

### âœ… ä¼˜ç‚¹

1. **ç»Ÿä¸€æŠ½è±¡çŸ¥è¯†æ¨¡åž‹ï¼ˆknowledgeï¼‰**
   * ä¸ä¸ºä¸åŒæ¥æºæ‹†è¡¨ï¼Œç®€åŒ–æ•°æ®æ¨¡åž‹

2. **å¤©ç„¶æ”¯æŒçŸ¥è¯†æ ‘**
   * é€šè¿‡ `parent_id` å®žçŽ°ä»»æ„æ·±åº¦çš„å±‚çº§ç»“æž„

3. **RAG åŽŸç”Ÿè®¾è®¡**
   * å‘é‡æ•°æ®ç‹¬ç«‹å­˜å‚¨åœ¨ PostgreSQLï¼Œä¸“ç²¾è¯­ä¹‰æ£€ç´¢

4. **ç©ºé—´å³æƒé™è¾¹ç•Œ**
   * é€šè¿‡ `space_id` å®žçŽ°å¤šç§Ÿæˆ·éš”ç¦»

5. **ä¸šåŠ¡ä¸Žå‘é‡åˆ†ç¦»**
   * MySQL è´Ÿè´£ç»“æž„åŒ–ä¸šåŠ¡æ•°æ®
   * PostgreSQL è´Ÿè´£å‘é‡æ£€ç´¢ï¼Œäº’ä¸å¹²æ‰°

6. **æ–‡æ¡£ & æ‰‹å·¥çŸ¥è¯†æ— ç¼èžåˆ**
   * ç»Ÿä¸€çš„å‘é‡åŒ–æµç¨‹ï¼Œç»Ÿä¸€çš„æ£€ç´¢æŽ¥å£

---

## å…«ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®

### MySQL ç´¢å¼•

```sql
-- spaces è¡¨
CREATE INDEX idx_spaces_user_id ON spaces(user_id);

-- knowledge è¡¨
CREATE INDEX idx_knowledge_space_id ON knowledge(space_id);
CREATE INDEX idx_knowledge_parent_id ON knowledge(parent_id);
CREATE INDEX idx_knowledge_type ON knowledge(type);
```

### PostgreSQL å‘é‡ç´¢å¼•

```sql
-- IVFFLAT ç´¢å¼•ï¼ˆé€‚åˆä¸­ç­‰è§„æ¨¡ï¼‰
CREATE INDEX document_chunk_embedding_idx 
ON document_chunk USING ivfflat (embedding vector_cosine_ops);

-- å¦‚æžœæ•°æ®é‡å¤§ï¼ˆ>100ä¸‡ï¼‰ï¼Œè€ƒè™‘ HNSW ç´¢å¼•
CREATE INDEX document_chunk_embedding_hnsw_idx 
ON document_chunk USING hnsw (embedding vector_cosine_ops);
```

### æŸ¥è¯¢ä¼˜åŒ–

```sql
-- RAG æ£€ç´¢æŸ¥è¯¢ï¼ˆä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼‰
SELECT 
    content, 
    metadata,
    1 - (embedding <=> '[0.123, -0.456, ...]') AS similarity
FROM document_chunk
WHERE metadata->>'spaceId' = '456'
ORDER BY embedding <=> '[0.123, -0.456, ...]'
LIMIT 5;
```